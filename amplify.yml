version: 1
backend:
  phases:
    build:
      commands:
        - corepack enable
        - corepack prepare pnpm@10.12.1 --activate
        - pnpm install --frozen-lockfile
        - echo "AMPLIFY_PRODUCTION=$AMPLIFY_PRODUCTION" >> .env
        - echo "ENABLE_TEST_API=$ENABLE_TEST_API" >> .env
        - echo "HOSTZONE_ID=$HOSTZONE_ID" >> .env
        - echo "HOSTZONE_NAME=$HOSTZONE_NAME" >> .env
        - echo "MANAGED_LOGIN_SUBDOMAIN=$MANAGED_LOGIN_SUBDOMAIN" >> .env
        - echo "MANAGED_LOGIN_DOMAIN=$MANAGED_LOGIN_DOMAIN" >> .env
        - echo "CERTIFICATE_ARN=$CERTIFICATE_ARN" >> .env
        - echo "CDN_DOMAIN=$CDN_DOMAIN" >> .env
        - echo "CDN_SUBDOMAIN=$CDN_SUBDOMAIN" >> .env
        - pnpm ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
    postBuild:
      commands:
        - echo "👥 管理者ユーザーを作成します"
        - echo "ADMIN_USERNAME=$ADMIN_USERNAME" >> .env
        - echo "ADMIN_PASSWORD=$ADMIN_PASSWORD" >> .env
        - echo "TEST_ADMIN_USERNAME=$TEST_ADMIN_USERNAME" >> .env
        - echo "TEST_ADMIN_PASSWORD=$TEST_ADMIN_PASSWORD" >> .env
        - pnpm run create:admin-users

# TODO ヒアドキュメントに変更する
frontend:
  phases:
    build:
      commands:
        - echo "AMPLIFY_PRODUCTION=$AMPLIFY_PRODUCTION" >> .env
        - echo "ENABLE_TEST_API=$ENABLE_TEST_API" >> .env
        - echo "AMPLIFY_APP_ORIGIN=$AMPLIFY_APP_ORIGIN" >> .env
        - echo "GOOGLE_CALLBACK_URLS=$GOOGLE_CALLBACK_URLS" >> .env
        - echo "GOOGLE_LOGOUT_URLS=$GOOGLE_LOGOUT_URLS" >> .env
        - echo "STRIPE_SUCCESS_URL=$STRIPE_SUCCESS_URL" >> .env
        - echo "STRIPE_CANCEL_URL=$STRIPE_CANCEL_URL" >> .env
        - echo "COOKIE_DOMAIN=$COOKIE_DOMAIN" >> .env
        - echo "SEED_BUCKET_ARN=$SEED_BUCKET_ARN" >> .env
        - echo "SEED_BUCKET_REGION=$SEED_BUCKET_REGION" >> .env
        - echo "ADMIN_USERNAME=$ADMIN_USERNAME" >> .env
        - echo "ADMIN_PASSWORD=$ADMIN_PASSWORD" >> .env
        - echo "STRIPE_API_KEY=$STRIPE_API_KEY" >> .env
        - echo "STRIPE_WEBHOOK_SECRET=$STRIPE_WEBHOOK_SECRET" >> .env
        - echo "INSTAGRAM_URL=$INSTAGRAM_URL" >> .env
        - echo "NEXT_PUBLIC_CONTACT_EMAIL=$NEXT_PUBLIC_CONTACT_EMAIL" >> .env
        - echo "SIGNED_URL_EXPIRE_MINUTES=$SIGNED_URL_EXPIRE_MINUTES" >> .env
        - echo "SIGNED_URL_EXPIRE_WARNING_MINUTES=$SIGNED_URL_EXPIRE_WARNING_MINUTES" >> .env
        - echo "TEST_ADMIN_USERNAME=$TEST_ADMIN_USERNAME" >> .env
        - echo "TEST_ADMIN_PASSWORD=$TEST_ADMIN_PASSWORD" >> .env
        - pnpm build
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - .next/cache/**/*
      - ~/.pnpm-store/**/*
      - node_modules/.cache/**/*
